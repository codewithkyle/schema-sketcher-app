import u from"./env.js";import{createSubscription as w,subscribe as M,unsubscribe as E}from"./pubsub.js";import L from"./debounce.js";import f from"./diagram-controller.js";import R from"./context-menu.js";const C="#9CA3AF",N="#EC4899";class b extends HTMLElement{constructor(){super();this.onContextMenu=o=>{if(o.preventDefault(),this.openStartPoint===null&&this.activeLineId!==null&&o instanceof MouseEvent){const h=this.activeLineId,e=o.clientX,i=o.clientY;document.body.querySelectorAll("brixi-context-menu").forEach(x=>x.remove()),new R({items:[{label:"One-to-one",callback:()=>{f.updateConnectionType(h,"one-one")}},{label:"One-to-many",callback:()=>{f.updateConnectionType(h,"one-many")}},{label:"Many-to-one",callback:()=>{f.updateConnectionType(h,"many-one")}},{label:"Many-to-many",callback:()=>{f.updateConnectionType(h,"many-many")}},null,{label:"Delete",callback:()=>{f.deleteConnection(h)}}],x:e,y:i})}};this.endMouseMove=o=>{this.openStartPoint=null};this.handleMouseMove=o=>{this.mousePos={x:o.clientX,y:o.clientY};const e=this.hitCTX.getImageData(o.clientX,o.clientY,1,1).data,i=`rgb(${e[0]},${e[1]},${e[2]})`;if(i!=="rgb(0,0,0)"){const x=this.colorRef[i];x!==void 0?this.activeLineId=x:this.activeLineId=null}else this.activeLineId=null};this.x=0,this.y=0,this.w=0,this.h=0,this.openStartPoint=null,this.mousePos=null,this.lines=[],this.forceHighlight=null,this.activeLineId=null,this.colorRef={},u.css(["canvas-component"]),w("canvas"),this.ticketID=M("canvas",this.inbox.bind(this))}async connectedCallback(){this.canvas=this.querySelector("canvas")||document.createElement("canvas"),this.canvas.isConnected||this.appendChild(this.canvas),this.hitCanvas=this.querySelector("canvas.hit")||document.createElement("canvas"),this.hitCanvas.isConnected||(this.hitCanvas.classList.add("hit"),this.appendChild(this.hitCanvas)),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.hitCanvas.width=window.innerWidth,this.hitCanvas.height=window.innerHeight,this.ctx=this.canvas.getContext("2d"),this.hitCTX=this.hitCanvas.getContext("2d"),window.addEventListener("mousemove",this.handleMouseMove),window.addEventListener("mousedown",this.endMouseMove),window.addEventListener("contextmenu",this.onContextMenu),window.addEventListener("resize",L(()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.hitCanvas.width=window.innerWidth,this.hitCanvas.height=window.innerHeight},300)),this.oldTime=performance.now(),this.eventLoop()}disconnectedCallback(){this.eventLoop=async()=>{},E(this.ticketID),window.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("mousedown",this.endMouseMove)}startNewLine(o,h,e,i,x=[]){this.openStartPoint={x:o,y:h,id:e,tableID:i,refs:x},this.mousePos={x:o,y:h}}endLine(o,h,e=[]){this.openStartPoint!==null&&o!==this.openStartPoint.id&&h!==this.openStartPoint.tableID&&(f.createConnection(this.openStartPoint.id,o,[...this.openStartPoint.refs,...e]),this.openStartPoint=null)}async inbox(o){switch(o.type){case"clear-highlight":o.ref===this.forceHighlight&&(this.forceHighlight=null);break;case"highlight":this.forceHighlight=o.ref;break;case"start":this.startNewLine(o.x,o.y,o.id,o.tableID,o.refs);break;case"end":this.endLine(o.id,o.tableID,o.refs);break;default:console.warn(`Invalid 'canvas' message type: ${o.type}`);break}}drawLine(o,h,e,i,x,a,n,T="one-one"){let t=(o+e)*.5,s=(h+i)*.5;if(this.ctx.beginPath(),this.ctx.moveTo(o,h),x==="left"&&a==="left"){o<=e?t=o-16:t=e-16;let c,l;switch(Math.abs(h-i)>=32?(e<=o?(c=i>=h?-8:8,l=e<=o?8:-8):(c=i>=h?-8:8,l=e<=o?-8:8),this.ctx.lineTo(t+l,h),this.ctx.arcTo(t,h,t,h-c,8),this.ctx.lineTo(t,i+c),this.ctx.arcTo(t,i,t+l,i,8),this.ctx.lineTo(e,i)):(this.ctx.lineTo(t,h),this.ctx.lineTo(t,i),this.ctx.lineTo(e,i)),T){case"one-one":break;case"one-many":this.ctx.moveTo(e,i-8),this.ctx.lineTo(e-8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e-8,i);break;case"many-one":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o-8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o-8,h);break;case"many-many":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o-8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o-8,h),this.ctx.moveTo(e,i-8),this.ctx.lineTo(e-8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e-8,i);break}this.hitCTX.fillStyle=n,this.hitCTX.fillRect(t,h-8,Math.abs(o-t),16),this.hitCTX.fillRect(t,i-8,Math.abs(e-t),16),i<h?this.hitCTX.fillRect(t-8,i-8,16,Math.abs(h-i)+16):this.hitCTX.fillRect(t-8,h-8,16,Math.abs(h-i)+16)}else if(x==="right"&&a==="right"){if(o>=e?t=o+16:t=e+16,Math.abs(h-i)>=32){let c,l;e<=o?(c=i>=h?-8:8,l=e<=o?-8:8):(c=i>=h?-8:8,l=e<=o?8:-8),this.ctx.lineTo(t+l,h),this.ctx.arcTo(t,h,t,h-c,8),this.ctx.lineTo(t,i+c),this.ctx.arcTo(t,i,t+l,i,8),this.ctx.lineTo(e,i)}else this.ctx.lineTo(t,h),this.ctx.lineTo(t,i),this.ctx.lineTo(e,i);switch(T){case"one-one":break;case"one-many":this.ctx.moveTo(e,i-8),this.ctx.lineTo(e+8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e+8,i);break;case"many-one":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o+8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o+8,h);break;case"many-many":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o+8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o+8,h),this.ctx.moveTo(e,i-8),this.ctx.lineTo(e+8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e+8,i);break}this.hitCTX.fillStyle=n,this.hitCTX.fillRect(o,h-8,Math.abs(o-t),16),this.hitCTX.fillRect(e,i-8,Math.abs(e-t),16),i<h?this.hitCTX.fillRect(t-8,i-8,16,Math.abs(h-i)+16):this.hitCTX.fillRect(t-8,h-8,16,Math.abs(h-i)+16)}else if(x==="left"&&a==="right"&&o<=e){switch(o<=e?t=o-16:t=e-16,h<=i?(this.ctx.lineTo(t+8,h),this.ctx.arcTo(t,h,t,h+8,8),this.ctx.lineTo(t,s-8),this.ctx.arcTo(t,s,t+8,s,8),this.ctx.lineTo(e+8,s),this.ctx.arcTo(e+16,s,e+16,s+8,8),this.ctx.lineTo(e+16,i-8),this.ctx.arcTo(e+16,i,e-8,i,8),this.ctx.lineTo(e,i)):(this.ctx.lineTo(t+8,h),this.ctx.arcTo(t,h,t,h-8,8),this.ctx.lineTo(t,s+8),this.ctx.arcTo(t,s,t+8,s,8),this.ctx.lineTo(e+8,s),this.ctx.arcTo(e+16,s,e+16,s-8,8),this.ctx.lineTo(e+16,i+8),this.ctx.arcTo(e+16,i,e-8,i,8),this.ctx.lineTo(e,i)),T){case"one-one":break;case"one-many":this.ctx.moveTo(e,i-8),this.ctx.lineTo(e+8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e+8,i);break;case"many-one":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o-8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o-8,h);break;case"many-many":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o-8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o-8,h),this.ctx.moveTo(e,i-8),this.ctx.lineTo(e+8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e+8,i);break}this.hitCTX.fillStyle=n,this.hitCTX.fillRect(o-16,h-8,16,16),this.hitCTX.fillRect(e,i-8,16,16),this.hitCTX.fillRect(o-24,s-8,Math.abs(e-o)+32,16),i<h?(this.hitCTX.fillRect(t-8,s-8,16,Math.abs(h-i)*.5+16),this.hitCTX.fillRect(e+8,i-8,16,Math.abs(h-i)*.5+16)):(this.hitCTX.fillRect(o-32,h-8,16,Math.abs(h-i)*.5+16),this.hitCTX.fillRect(e+8,s-8,16,Math.abs(h-i)*.5+16))}else if(x==="right"&&a==="left"&&e<=o){switch(o>=e?t=o+16:t=e+16,h<=i?(this.ctx.lineTo(t-8,h),this.ctx.arcTo(t,h,t,h+8,8),this.ctx.lineTo(t,s-8),this.ctx.arcTo(t,s,t-8,s,8),this.ctx.lineTo(e-8,s),this.ctx.arcTo(e-16,s,e-16,s+8,8),this.ctx.lineTo(e-16,i-8),this.ctx.arcTo(e-16,i,e+8,i,8),this.ctx.lineTo(e,i)):(this.ctx.lineTo(t-8,h),this.ctx.arcTo(t,h,t,h-8,8),this.ctx.lineTo(t,s+8),this.ctx.arcTo(t,s,t-8,s,8),this.ctx.lineTo(e-8,s),this.ctx.arcTo(e-16,s,e-16,s-8,8),this.ctx.lineTo(e-16,i+8),this.ctx.arcTo(e-16,i,e+8,i,8),this.ctx.lineTo(e,i)),T){case"one-one":break;case"one-many":this.ctx.moveTo(e,i-8),this.ctx.lineTo(e-8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e-8,i);break;case"many-one":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o+8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o+8,h);break;case"many-many":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o+8,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o+8,h),this.ctx.moveTo(e,i-8),this.ctx.lineTo(e-8,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e-8,i);break}this.hitCTX.fillStyle=n,this.hitCTX.fillRect(o,h-8,Math.abs(o-t),16),this.hitCTX.fillRect(e-16,i-8,Math.abs(e-t),16),this.hitCTX.fillRect(e-24,s-8,Math.abs(e-o)+32,16),i<h?(this.hitCTX.fillRect(t-8,s-8,16,Math.abs(h-i)*.5+16),this.hitCTX.fillRect(e-24,i-8,16,Math.abs(h-i)*.5+16)):(this.hitCTX.fillRect(t-8,h-8,16,Math.abs(h-i)*.5+16),this.hitCTX.fillRect(e-24,s-8,16,Math.abs(h-i)*.5+16))}else if(x==="right"&&a==="left"||x==="left"&&a==="right"){const c=i>=h?-8:8,l=e<=o?8:-8;switch(Math.abs(h-i)>=16&&Math.abs(o-e)>=16?(this.ctx.lineTo(t+l,h),this.ctx.arcTo(t,h,t,h+c*-1,8),this.ctx.lineTo(t,i+c),this.ctx.arcTo(t,i,t+l*-1,i,8),this.ctx.lineTo(e,i)):(this.ctx.lineTo(t,h),this.ctx.lineTo(t,i),this.ctx.lineTo(e,i)),T){case"one-one":break;case"one-many":this.ctx.moveTo(e,i-8),this.ctx.lineTo(e+l,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e+l,i);break;case"many-one":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o-l,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o-l,h);break;case"many-many":this.ctx.moveTo(o,h-8),this.ctx.lineTo(o-l,h),this.ctx.moveTo(o,h+8),this.ctx.lineTo(o-l,h),this.ctx.moveTo(e,i-8),this.ctx.lineTo(e+l,i),this.ctx.moveTo(e,i+8),this.ctx.lineTo(e+l,i);break}this.hitCTX.fillStyle=n,x==="right"&&a==="left"?(this.hitCTX.fillRect(o,h-8,Math.abs(o-t),16),this.hitCTX.fillRect(t,i-8,Math.abs(e-t),16),i<h?this.hitCTX.fillRect(t+l,i-8,16,Math.abs(h-i)+16):this.hitCTX.fillRect(t+l,h-8,16,Math.abs(h-i)+16)):(this.hitCTX.fillRect(e,i-8,Math.abs(e-t),16),this.hitCTX.fillRect(t,h-8,Math.abs(o-t),16),i<h?this.hitCTX.fillRect(t-8,i-8,16,Math.abs(h-i)+16):this.hitCTX.fillRect(t-8,h-8,16,Math.abs(h-i)+16))}else this.ctx.lineTo(e,i),console.warn(`missing type: ${x} ${a}`);this.ctx.stroke()}getElement(o){return document.body.querySelector(o)}async eventLoop(){const o=performance.now(),h=(o-this.oldTime)/1e3;this.oldTime=o,this.lines=f.getConnections();const e=[];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.hitCTX.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.canvas.getBoundingClientRect();this.ctx.lineWidth=1;try{if(this.openStartPoint!==null){this.ctx.strokeStyle=C;const n=this.getElement(`[data-uid="${this.openStartPoint.id}"]`).getBoundingClientRect(),{x:T,y:t}=this.mousePos;let s,c;T<=n.x?(s="left",c="left"):T>=n.x&&T<=n.x+n.width?T>=n.x+n.width*.5?(s="right",c="right"):(s="left",c="left"):T>n.x+n.width?(s="right",c="left"):(s="left",c="right");const m=this.getElement(`[data-uid="${this.openStartPoint.id}_${s}"]`).getBoundingClientRect(),r=m.x-i.x+m.width*.5,v=m.y-i.y+m.height*.5;this.drawLine(r,v,T-i.x,t-i.y,s,c,"#000000")}}catch(a){console.error("Failed to draw temp line.",a)}const x=[];for(let a=0;a<this.lines.length;a++)try{const n=this.getElement(`[data-uid="${this.lines[a].startNodeID}"]`),T=this.getElement(`[data-uid="${this.lines[a].endNodeID}"]`);this.lines[a].uid in this.colorRef||(this.colorRef[this.lines[a].color]=this.lines[a].uid);const t=n.getBoundingClientRect(),s=T.getBoundingClientRect();let c,l;n.tagName==="NODE-COMPONENT"&&T.tagName==="NODE-COMPONENT"?(s.x+s.width<=t.x?c="left":s.x>=t.x+t.width?c="right":s.y<=t.y+t.height*.5?c="top":c="bottom",s.x>=t.x+t.width?l="left":s.x+s.width<=t.x?l="right":s.y<=t.y+t.height*.5?l="bottom":l="top"):n.tagName==="NODE-COMPONENT"&&T.tagName==="COLUMN-COMPONENT"?s.x>=t.x+t.width&&Math.abs(s.x-(t.width+t.x))>=64?(c="right",l="left"):s.x+s.width<=t.x&&Math.abs(s.x+s.width-t.x)>=64?(c="left",l="right"):s.x+s.width*.5>=t.x+t.width*.5?(l="left",c="left"):(l="right",c="right"):n.tagName==="COLUMN-COMPONENT"&&T.tagName==="NODE-COMPONENT"?s.x>=t.x+t.width?(c="right",Math.abs(t.y-s.y)>=64?s.y<=t.y+t.height*.5?l="bottom":l="top":l="left"):s.x<=t.x?(c="left",s.x+32<t.x?Math.abs(t.y-s.y)>=64?s.y<=t.y+t.height*.5?l="bottom":l="top":l="right":l="left"):s.x<=t.x+t.width*.5?(c="left",l="left"):(c="right",l="right"):n.tagName==="COLUMN-COMPONENT"&&T.tagName==="COLUMN-COMPONENT"?s.x>=t.x&&s.x<=t.x+t.width?s.x>t.x+t.width*.5?(c="right",l="left"):(c="right",l="right"):t.x>=s.x&&t.x<=s.x+s.width?t.x>s.x+s.width*.5?(c="left",l="right"):(c="left",l="left"):t.x+t.width>=s.x?(c="left",l="right"):(c="right",l="left"):(c="NO-CONNECTION",l="NO-CONNECTION");const m=this.getElement(`[data-uid="${this.lines[a].startNodeID}_${c}"]`),r=this.getElement(`[data-uid="${this.lines[a].endNodeID}_${l}"]`),v=m.getBoundingClientRect(),g=r.getBoundingClientRect(),y={x:v.x+v.width*.5-i.x,y:v.y+v.height*.5-i.y},p={x:g.x+g.width*.5-i.x,y:g.y+g.height*.5-i.y};x.push({start:y,end:p,uid:this.lines[a].uid,startSide:c,endSide:l,refs:this.lines[a].refs,color:this.lines[a].color,type:this.lines[a].type})}catch{console.error("Failed to get line data",this.lines[a])}for(let a=0;a<x.length;a++){const n=x[a];this.forceHighlight!==null&&n.refs.includes(this.forceHighlight)&&e.push(n.uid)}this.activeLineId!==null&&e.push(this.activeLineId);for(let a=0;a<x.length;a++){const n=x[a];if(!e.includes(n.uid)){const{x:T,y:t}=n.start,{x:s,y:c}=n.end;this.ctx.strokeStyle=C,this.drawLine(T,t,s,c,n.startSide,n.endSide,n.color,n.type)}}for(let a=0;a<x.length;a++){const n=x[a];if(e.includes(n.uid)){const{x:T,y:t}=n.start,{x:s,y:c}=n.end;this.ctx.strokeStyle=N,this.drawLine(T,t,s,c,n.startSide,n.endSide,n.color,n.type)}}window.requestAnimationFrame(this.eventLoop.bind(this))}}u.bind("canvas-component",b);export{b as default};
