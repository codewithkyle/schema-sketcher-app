import{UUID as r}from"./uuid.js";import{publish as n}from"./pubsub.js";import{MYSQL_TYPES as p,POSTGRES_TYPES as h,SQLITE_TYPES as b,SQL_SERVER_TYPES as y}from"./column-types.js";import f from"./modals.js";import{html as C}from"./lit-html.js";import{COLORS as d,SHADES as u,COLOR_CODES as v}from"./colors.js";import*as g from"./lz-string.js";import c from"./alerts.js";class S{constructor(){this.onSelect=t=>{const a=t.currentTarget.dataset.type;this.type=a,this.createDiagramCallback(a)};this.onOpen=t=>{if(window?.showOpenFilePicker)openFile({description:"Schema Sketcher Diagram",mimeTypes:["application/json"],extensions:[".json"]}).then(e=>{const a=new FileReader;a.onload=i=>{const s=i.target.result;this.type="file",this.createDiagramCallback("file"),setTimeout(()=>{this.import(s),c.toast("File opened")},80)},a.readAsText(e)});else{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=a=>{const i=e.files[0],s=new FileReader;s.onload=o=>{const l=o.target.result;this.type="file",this.createDiagramCallback("file"),setTimeout(()=>{this.import(l),c.toast("File opened")},80)},s.readAsText(i)},e.click()}};this.ID=r(),this.type=null,this.tableCount=0,this.diagram=null,this.createDiagramCallback=()=>{}}importFromURI(t){try{const e=JSON.parse(g.decompressFromEncodedURIComponent(t));return this.type="file",this.diagram=e,setTimeout(()=>{n("diagram",{type:"load"})},80),this.diagram}catch(e){return console.error(e),c.toast("Failed to import diagram from URL"),null}}exportAsURI(){const t=g.compressToEncodedURIComponent(JSON.stringify(this.diagram));return[this.diagram,t]}getRandomColor(){const t=this.getRandomInt(0,d.length-1),e=this.getRandomInt(0,u.length-1);return v[d[t]][u[e]]}getRandomInt(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}async createDiagram(){let t;await new Promise(i=>{this.createDiagramCallback=i,t=f.raw({view:C`
                    <h1 class="block text-center font-sm font-grey-500 mt-1.5">Select a database to begin</h1>
                    <div class="databases">
                        <button @mousedown=${this.onSelect} data-type="mysql">
                            <img src="/assets/mysql.png" alt="MySQL" />
                            <span>MySQL</span>
                        </button>
                        <button @mousedown=${this.onSelect} data-type="postgresql">
                            <img src="/assets/postgresql.png" alt="PostgreSQL" />
                            <span>PostgreSQL</span>
                        </button>
                        <button @mousedown=${this.onSelect} data-type="sqlite">
                            <img src="/assets/sqlite.png" alt="SQLite" />
                            <span>SQLite</span>
                        </button>
                        <button @mousedown=${this.onSelect} data-type="mssql">
                            <img src="/assets/sql-server.png" alt="SQL Server" />
                            <span>SQL Server</span>
                        </button>
                    </div>
                    <div class="divider">
                        <i></i>
                        <span>OR</span>
                        <i></i>
                    </div>
                    <div class="actions">
                        <button
                            @mousedown=${this.onSelect}
                            data-type="custom"
                            class="bttn"
                            kind="solid"
                            color="grey"
                            icon="left"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-database-edit"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6c0 1.657 3.582 3 8 3s8 -1.343 8 -3s-3.582 -3 -8 -3s-8 1.343 -8 3" /><path d="M4 6v6c0 1.657 3.582 3 8 3c.478 0 .947 -.016 1.402 -.046" /><path d="M20 12v-6" /><path d="M4 12v6c0 1.526 3.04 2.786 6.972 2.975" /><path d="M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z" /></svg>
                            <span>Custom schema</span>
                        </button>
                        <button
                            class="bttn"
                            kind="solid"
                            color="grey"
                            icon="left"
                            @mousedown=${this.onOpen}
                        >
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" /></svg>
                            <span>Open diagram</span>
                        </button>
                    </div>
                `})}),t&&t.remove();const e=r();this.ID=e;const a={};switch(this.type){case"mysql":p.map(i=>{const s=r();a[s]={name:i,uid:s}});break;case"postgresql":h.map(i=>{const s=r();a[s]={name:i,uid:s}});break;case"sqlite":b.map(i=>{const s=r();a[s]={name:i,uid:s}});break;case"mssql":y.map(i=>{const s=r();a[s]={name:i,uid:s}});break;default:break}return this.diagram={version:1,fileName:`Untitled-${Date.now()}`,uid:e,timestamp:Date.now(),tables:{},columns:{},nodes:{},connections:{},types:a},this.diagram}async reset(){await this.createDiagram(),n("diagram",{type:"reset"})}export(){return[this.diagram,JSON.stringify(this.diagram)]}import(t){n("diagram",{type:"reset"}),this.type="file",this.diagram=JSON.parse(t),setTimeout(()=>{n("diagram",{type:"load"})},80)}setFileName(t){this.diagram.fileName=t}createTable(t,e){const a=r(),i={uid:a,name:`table_${++this.tableCount}`,color:this.getRandomColor(),x:t,y:e};this.diagram.tables[a]=i,this.createColumn(a,"id",!0),n("diagram",{type:"dirty"})}createColumn(t,e="",a=!1){const i=r(),s={name:e,type:this.diagram.types[Object.keys(this.diagram.types)[0]].uid,isNullable:!1,isUnique:!1,isIndex:!1,isPrimaryKey:a,weight:0,uid:i,tableID:t};this.diagram.columns[i]=s,n("diagram",{type:"dirty"})}deleteColumn(t){Object.values(this.diagram.columns).filter(a=>a.tableID===this.diagram.columns[t].tableID).length-1===0?this.deleteTable(this.diagram.columns[t].tableID):(this.deleteElement(t),delete this.diagram.columns[t]),n("canvas",{type:"reload"}),n("diagram",{type:"dirty"})}getColumnsByTable(t){const e=Object.values(this.diagram.columns).filter(a=>a.tableID===t);return e.sort((a,i)=>a.weight-i.weight),e}getColumn(t){return this.diagram.columns[t]}reorderColumns(t){const e=document.body.querySelector(`table-component[data-uid="${t}"]`),a=Array.from(e.querySelectorAll("column-component"));for(let i=0;i<a.length;i++){const s=a[i].dataset.uid,o=this.getColumn(s);o.weight=i}n("diagram",{type:"dirty"})}moveColumn(t,e){this.diagram.columns[t].tableID=e,n("diagram",{type:"dirty"})}renameColumn(t,e){this.diagram.columns[t].name=e,n("diagram",{type:"dirty"})}changeColumnType(t,e){this.diagram.columns[t].type=e,n("diagram",{type:"dirty"})}changeColumnNullable(t,e){this.diagram.columns[t].isNullable=e,n("diagram",{type:"dirty"})}changeColumnUnique(t,e){this.diagram.columns[t].isUnique=e,n("diagram",{type:"dirty"})}changeColumnIndex(t,e){this.diagram.columns[t].isIndex=e,n("diagram",{type:"dirty"})}changeColumnPrimaryKey(t,e){this.diagram.columns[t].isPrimaryKey=e,n("diagram",{type:"dirty"})}renameTable(t,e){this.diagram.tables[t].name=e,n("diagram",{type:"dirty"})}updateTablePosition(t,e,a){this.diagram.tables[t].x=e,this.diagram.tables[t].y=a,n("diagram",{type:"dirty"})}changeTableColor(t,e){this.diagram.tables[t].color=e,n("diagram",{type:"dirty"})}cloneTable(t){this.tableCount++;const e=this.diagram.tables[t],a=JSON.parse(JSON.stringify(e)),i=r();a.uid=i,a.name=`${e.name}_copy`,a.x+=100,a.y+=100,a.color=this.getRandomColor(),this.diagram.tables[i]=a,Object.values(this.diagram.columns).filter(o=>o.tableID===e.uid).map(o=>{const l=r(),m=JSON.parse(JSON.stringify(o));m.uid=l,m.tableID=i,this.diagram.columns[l]=m}),n("diagram",{type:"load"}),n("diagram",{type:"dirty"})}async createNode(t,e){const a=r(),i={uid:a,text:"New node",x:t,y:e,color:"grey",icon:"function"};this.diagram.nodes[a]=i}createConnection(t,e,a){const i=r(),s={uid:i,startNodeID:t,endNodeID:e,type:"one-one",refs:a,color:this.randomRGBColor()};this.diagram.connections[i]=s,n("diagram",{type:"dirty"})}getConnections(){return Object.values(this.diagram.connections)}updateConnectionType(t,e){this.diagram.connections[t].type=e,n("diagram",{type:"dirty"})}deleteConnection(t){delete this.diagram.connections[t],n("diagram",{type:"dirty"})}getTypes(){return Object.values(this.diagram.types)}updateType(t,e){this.diagram.types[t].name=e,n("diagram",{type:"dirty"})}deleteType(t){if(Object.keys(this.diagram.types).length<=1)return!1;delete this.diagram.types[t];for(const e in this.diagram.columns)this.diagram.columns[e].type===t&&(this.diagram.columns[e].type=Object.keys(this.diagram.types)[0]);return n("diagram",{type:"dirty"}),!0}createType(t=""){const e=r(),a={name:t,uid:e};this.diagram.types[e]=a,n("diagram",{type:"dirty"})}getTables(){return this.diagram?Object.values(this.diagram.tables):[]}getTable(t){return this.diagram.tables[t]}getNodes(){return[]}deleteTable(t){delete this.diagram.tables[t],this.deleteElement(t),Object.keys(this.diagram.columns).filter(a=>this.diagram.columns[a].tableID===t).map(a=>{delete this.diagram.columns[a]}),n("canvas",{type:"reload"}),n("diagram",{type:"dirty"})}deleteNode(t){n("canvas",{type:"reload"})}deleteElement(t){document.body.querySelector(`[data-uid="${t}"]`)?.remove()}randomRGBColor(){return`rgb(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)})`}}const T=new S;var F=T;export{F as default};
